{% extends 'base.html.twig' %}

{% block title %}Admin - Tableau de bord{% endblock %}

{% block body %}
<section class="section-box">
  <h2 class="text-center text-success mb-5">ğŸ› ï¸ Tableau de bord administrateur</h2>

  <div class="row row-cols-1 row-cols-md-3 g-4">

    {# === COVOITURAGES === #}
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-success text-white fw-bold text-center">
          ğŸš— Covoiturages Ã  valider
        </div>
        <div class="card-body">
          {% if covoiturages is not empty %}
            {% for c in covoiturages %}
              <div class="mb-3 border-bottom pb-2">
                <strong>{{ c.lieuDepart }} â†’ {{ c.lieuArrivee }}</strong><br>
                ğŸ“… {{ c.dateDepart|date('d/m/Y') }}<br>
                ğŸ‘¤ {{ c.createdBy.firstname }}

                <div class="mt-2 d-flex flex-wrap gap-2">
                  <a href="{{ path('covoiturage_edit', {'id': c.id}) }}" class="btn btn-outline-warning btn-sm">âœï¸</a>
                  <a href="{{ path('admin_covoiturage_valider', {'id': c.id}) }}" class="btn btn-outline-success btn-sm">âœ…</a>
                  <a href="{{ path('admin_covoiturage_supprimer', {'id': c.id}) }}" class="btn btn-outline-danger btn-sm">ğŸ—‘ï¸</a>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">Aucun trajet en attente.</p>
          {% endif %}
        </div>
      </div>
    </div>

    {# === AVIS === #}
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-primary text-white fw-bold text-center">
          â­ Avis Ã  modÃ©rer
        </div>
        <div class="card-body">
          {% if avis is not empty %}
            {% for a in avis %}
              <div class="mb-3 border-bottom pb-2">
                â€œ{{ a.commentaire }}â€<br>
                â­ {{ a.note }}/5<br>
                ğŸ‘¤ {{ a.user.firstname }}

                <div class="mt-2 d-flex gap-2">
                  <a href="{{ path('admin_avis_valider', {'id': a.id}) }}" class="btn btn-outline-success btn-sm">âœ…</a>
                  <a href="{{ path('admin_avis_supprimer', {'id': a.id}) }}" class="btn btn-outline-danger btn-sm">ğŸ—‘ï¸</a>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">Aucun avis en attente.</p>
          {% endif %}
        </div>
      </div>
    </div>

    {# === VOITURES === #}
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-secondary text-white fw-bold text-center">
          ğŸš˜ Voitures enregistrÃ©es
        </div>
        <div class="card-body">
          {% if voitures is not empty %}
            {% for v in voitures %}
              <div class="mb-3 border-bottom pb-2">
                {{ v.modele }} â€“ {{ v.immatriculation }}<br>
                ğŸ‘¤ {{ v.user.firstname }}

                <div class="mt-2 d-flex gap-2">
                  <a href="{{ path('voiture_edit', {'id': v.id}) }}" class="btn btn-outline-warning btn-sm">âœï¸</a>
                  <a href="{{ path('admin_voiture_supprimer', {'id': v.id}) }}" class="btn btn-outline-danger btn-sm">ğŸ—‘ï¸</a>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">Aucune voiture enregistrÃ©e.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white fw-bold text-center">
          ğŸ“œ Historique des covoiturages passÃ©s
        </div>
        <div class="card-body">
          {% if historiques is not empty %}
            {% for h in historiques %}
              <div class="mb-3 border-bottom pb-2">
                <strong>{{ h.lieuDepart }} â†’ {{ h.lieuArrivee }}</strong><br>
                âœ… RÃ©alisÃ© le {{ h.dateDepart|date('d/m/Y') }}<br>
                ğŸ‘¤ {{ h.createdBy.firstname }}
              </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">Aucun trajet passÃ© enregistrÃ©.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white fw-bold text-center">
          ğŸ“Š Statistiques des crÃ©dits
        </div>
        <div class="card-body">
          <p>CrÃ©dits totaux gagnÃ©s : <strong>{{ totalCredits }}</strong></p>
          <p>CrÃ©dits gagnÃ©s aujourd'hui : <strong>{{ creditsToday }}</strong></p>
          <canvas id="creditChart" height="150"></canvas>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white fw-bold text-center">
          ğŸ‘¥ Gestion des utilisateurs
        </div>
        <div class="card-body">
          {% for user in users %}
            <div class="border-bottom pb-2 mb-3">
              <strong>{{ user.firstname }} {{ user.lastname }}</strong> â€” {{ user.email }}<br>
              RÃ´le(s) : {{ user.roles|join(', ') }}<br>
              Statut : 
              {% if user.isActive %}
                <span class="badge bg-success">Actif</span>
              {% else %}
                <span class="badge bg-secondary">Suspendu</span>
              {% endif %}

              <form method="post" action="{{ path('admin_admin_suspend_user', {'id': user.id}) }}" class="mt-2 d-inline">
                <input type="hidden" name="_token" value="{{ csrf_token('suspend' ~ user.id) }}">
                {% if user.isActive %}
                  <button class="btn btn-sm btn-danger">â›” Suspendre</button>
                {% else %}
                  <button class="btn btn-sm btn-secondary" disabled>DÃ©jÃ  suspendu</button>
                {% endif %}
              </form>
            </div>
          {% else %}
            <p class="text-muted">Aucun utilisateur trouvÃ©.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</section>

 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    const ctx = document.getElementById('creditChart');
    if (ctx) {
        new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ chartLabels|json_encode|raw }},
            datasets: [{
            label: 'CrÃ©dits par jour',
            data: {{ chartData|json_encode|raw }},
            backgroundColor: 'rgba(40, 167, 69, 0.6)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
            y: { beginAtZero: true }
            }
        }
        });
    }
    </script>

{% endblock %}